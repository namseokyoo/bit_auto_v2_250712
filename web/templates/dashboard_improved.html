{% extends "base.html" %}

{% block title %}ëŒ€ì‹œë³´ë“œ - Bitcoin Auto Trading v2{% endblock %}

{% block extra_head %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .metric-card {
        border: none;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }

    .metric-card:hover {
        transform: translateY(-2px);
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .status-active {
        background-color: #28a745;
    }

    .status-inactive {
        background-color: #6c757d;
    }

    .status-warning {
        background-color: #ffc107;
    }

    .big-number {
        font-size: 2.5rem;
        font-weight: bold;
        line-height: 1;
    }

    .control-btn {
        padding: 12px 24px;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.3s;
    }

    .pulse-animation {
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }

        100% {
            opacity: 1;
        }
    }

    .chart-mini {
        height: 80px;
        background: linear-gradient(45deg, #e3f2fd, #bbdefb);
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #1976d2;
        font-weight: 500;
    }

    .tier-performance-card {
        padding: 0.5rem;
        border-radius: 0.25rem;
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* AI ë¶„ì„ ìŠ¤íƒ€ì¼ */
    .analysis-content {
        max-height: 300px;
        overflow-y: auto;
        padding: 0.5rem;
        border-radius: 0.25rem;
        background-color: rgba(255, 255, 255, 0.5);
    }

    .analysis-text {
        font-size: 0.9rem;
        line-height: 1.4;
        white-space: pre-wrap;
    }

    #ai-analysis-content {
        transition: all 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<!-- ìƒë‹¨ ì œì–´ íŒ¨ë„ -->
<div class="card mb-4" style="border-left: 5px solid #007bff;">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center">
                    <div class="me-4">
                        <small class="text-muted">ì‹œìŠ¤í…œ ìƒíƒœ:</small>
                        {% if system_status.system_enabled %}
                        <span id="system-enabled-badge" class="badge bg-success">í™œì„±í™”</span>
                        {% else %}
                        <span id="system-enabled-badge" class="badge bg-secondary">ë¹„í™œì„±í™”</span>
                        {% endif %}
                    </div>
                    <div class="me-4">
                        <small class="text-muted">ê±°ë˜ ìƒíƒœ:</small>
                        {% if system_status.trading_enabled %}
                        <span id="trading-enabled-badge" class="badge bg-success">í™œì„±í™”</span>
                        {% else %}
                        <span id="trading-enabled-badge" class="badge bg-secondary">ë¹„í™œì„±í™”</span>
                        {% endif %}
                    </div>
                    <div class="me-4">
                        <small class="text-muted">ë‹¤ìŒ ì‹¤í–‰:</small>
                        <span id="next-execution" class="fw-bold text-primary">ê³„ì‚°ì¤‘...</span>
                    </div>
                    <div>
                        <small class="text-muted">ì„±ê³µë¥ :</small>
                        <span id="success-rate-display" class="fw-bold text-success">0.0%</span>
                    </div>
                </div>
            </div>
            <div class="col-md-4 text-end">
                {% if system_status.system_enabled %}
                <button id="system-toggle-btn" class="btn btn-warning control-btn me-2" onclick="toggleSystemButton()">
                    <i id="system-btn-icon" class="fas fa-pause me-2"></i>
                    <span id="system-btn-text">ì‹œìŠ¤í…œì •ì§€</span>
                </button>
                {% else %}
                <button id="system-toggle-btn" class="btn btn-secondary control-btn me-2"
                    onclick="toggleSystemButton()">
                    <i id="system-btn-icon" class="fas fa-power-off me-2"></i>
                    <span id="system-btn-text">ì‹œìŠ¤í…œì‹œì‘</span>
                </button>
                {% endif %}

                {% if system_status.trading_enabled %}
                <button id="trading-toggle-btn" class="btn btn-warning control-btn" onclick="toggleTradingButton()">
                    <i id="trading-btn-icon" class="fas fa-pause me-2"></i>
                    <span id="trading-btn-text">ê±°ë˜ì •ì§€</span>
                </button>
                {% else %}
                <button id="trading-toggle-btn" class="btn btn-primary control-btn" onclick="toggleTradingButton()">
                    <i id="trading-btn-icon" class="fas fa-play me-2"></i>
                    <span id="trading-btn-text">ê±°ë˜ì‹œì‘</span>
                </button>
                {% endif %}
                <button class="btn btn-danger control-btn ms-2" onclick="emergencyStop()">
                    <i class="fas fa-stop me-2"></i>ê¸´ê¸‰ì •ì§€
                </button>
            </div>
        </div>
    </div>
</div>

<!-- í•µì‹¬ ë©”íŠ¸ë¦­ -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card metric-card text-center">
            <div class="card-body">
                <i class="fas fa-wallet text-primary mb-2" style="font-size: 2rem;"></i>
                <h6 class="text-muted">ì´ ìì‚°</h6>
                <div id="total-balance" class="big-number text-primary">â‚© 186,901</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card text-center">
            <div class="card-body">
                <i class="fas fa-chart-line text-success mb-2" style="font-size: 2rem;"></i>
                <h6 class="text-muted">ì´ ìˆ˜ìµ/ì†ì‹¤</h6>
                <div id="total-pnl" class="big-number text-success">+â‚© 0</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card text-center">
            <div class="card-body">
                <i class="fas fa-exchange-alt text-info mb-2" style="font-size: 2rem;"></i>
                <h6 class="text-muted">ì´ ê±°ë˜</h6>
                <div id="total-trades" class="big-number text-info">0</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card metric-card text-center">
            <div class="card-body">
                <i class="fas fa-trophy text-warning mb-2" style="font-size: 2rem;"></i>
                <h6 class="text-muted">ìŠ¹ë¥ </h6>
                <div id="win-rate" class="big-number text-warning">0.0%</div>
            </div>
        </div>
    </div>
</div>

<!-- ë¹ ë¥¸ ì•¡ì…˜ ë° ì •ë³´ -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-hand-paper text-primary"></i> ë¹ ë¥¸ ê±°ë˜</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-4">
                        <button class="btn btn-outline-primary w-100 mb-2" onclick="analyzeAndExecute()">
                            <i class="fas fa-chart-line d-block mb-1" style="font-size: 1.5rem;"></i>
                            <small>ì „ëµ ë¶„ì„</small>
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-success w-100 mb-2" onclick="manualExecute('buy')">
                            <i class="fas fa-plus d-block mb-1" style="font-size: 1.5rem;"></i>
                            <small>ë§¤ìˆ˜</small>
                        </button>
                    </div>
                    <div class="col-4">
                        <button class="btn btn-outline-danger w-100 mb-2" onclick="manualExecute('sell')">
                            <i class="fas fa-minus d-block mb-1" style="font-size: 1.5rem;"></i>
                            <small>ë§¤ë„</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-area text-info"></i> ì‹œì¥ ì²´ì œ</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="mb-2">
                            <small class="text-muted">í˜„ì¬ ì²´ì œ</small>
                            <div id="current-regime" class="fw-bold text-primary">ê°ì§€ ì¤‘...</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="mb-2">
                            <small class="text-muted">ì‹ ë¢°ë„</small>
                            <div id="regime-confidence" class="fw-bold text-success">-</div>
                        </div>
                    </div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">íŒë‹¨ ê·¼ê±°:</small>
                    <div id="regime-reasoning" class="small text-muted">-</div>
                </div>
                <div class="mt-2">
                    <small class="text-muted">ì£¼ìš” ì§€í‘œ:</small>
                    <div class="row small">
                        <div class="col-4 text-center">
                            <div class="text-muted">RSI</div>
                            <div id="regime-rsi" class="fw-bold">-</div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="text-muted">ATR</div>
                            <div id="regime-atr" class="fw-bold">-</div>
                        </div>
                        <div class="col-4 text-center">
                            <div class="text-muted">ê±°ë˜ëŸ‰</div>
                            <div id="regime-volume" class="fw-bold">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì¶”ê°€ ì •ë³´ ì„¹ì…˜ -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-bitcoin text-warning"></i> í˜„ì¬ ê°€ê²©</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h3 id="btc-price" class="text-warning mb-0">â‚© ë¡œë”©ì¤‘...</h3>
                        <small id="price-change" class="text-muted">ë¹„íŠ¸ì½”ì¸ (BTC)</small>
                    </div>
                    <div class="chart-mini" onclick="showRealtimeChart()" style="cursor: pointer;">
                        <i class="fas fa-chart-area me-2"></i>
                        ì‹¤ì‹œê°„ ì°¨íŠ¸
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì „ëµ ì„±ê³¼ ëª¨ë‹ˆí„°ë§ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-chart-bar text-success"></i> ì „ëµ ì„±ê³¼ (ìµœê·¼ 24ì‹œê°„)</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/strategy_analytics'">
                    ìƒì„¸ ë¶„ì„
                </button>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="performance-metric">
                            <h6 class="text-muted">ì´ ì‹¤í–‰</h6>
                            <div id="strategy-total-executions" class="big-number text-primary">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="performance-metric">
                            <h6 class="text-muted">ì‹ í˜¸ ë°œìƒ</h6>
                            <div id="strategy-total-signals" class="big-number text-info">0</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="performance-metric">
                            <h6 class="text-muted">í‰ê·  ì‹ ë¢°ë„</h6>
                            <div id="strategy-avg-confidence" class="big-number text-warning">0.0%</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="performance-metric">
                            <h6 class="text-muted">ì„±ê³µë¥ </h6>
                            <div id="strategy-success-rate" class="big-number text-success">0.0%</div>
                        </div>
                    </div>
                </div>

                <!-- ê³„ì¸µë³„ ì„±ê³¼ ìš”ì•½ -->
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="text-muted mb-2">ê³„ì¸µë³„ ì„±ê³¼</h6>
                        <div class="row" id="strategy-tier-performance">
                            <div class="col-md-4">
                                <div class="tier-performance-card">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-success">ìŠ¤ìº˜í•‘</span>
                                        <small id="scalping-performance" class="text-muted">ì‹¤í–‰ 0íšŒ</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="tier-performance-card">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-info">íŠ¸ë Œë“œ</span>
                                        <small id="trend-performance" class="text-muted">ì‹¤í–‰ 0íšŒ</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="tier-performance-card">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="badge bg-primary">í†µí•©</span>
                                        <small id="integrated-performance" class="text-muted">ì‹¤í–‰ 0íšŒ</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- AI ë¶„ì„ ë° ì¡°ì–¸ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-robot text-primary"></i> AI ë¶„ì„ ë° ì¡°ì–¸</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="executeAIAnalysis()">
                        <i class="fas fa-brain"></i> AI ë¶„ì„
                    </button>
                    <button
                        class="btn btn-sm {% if ai_scheduler_status.enabled %}btn-success{% else %}btn-outline-secondary{% endif %} me-2"
                        onclick="toggleAIScheduler()" id="ai-scheduler-btn">
                        <i class="fas fa-clock"></i> <span id="ai-scheduler-text">{% if ai_scheduler_status.enabled %}ìë™
                            ì‹¤í–‰ ì¤‘{% else %}ìë™ ì‹¤í–‰{% endif %}</span>
                    </button>

                </div>
            </div>
            <div class="card-body" id="ai-analysis-content">
                <!-- AI ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="alert alert-info d-flex justify-content-between align-items-center"
                            style="margin-bottom: 1rem;">
                            <div>
                                <strong><i class="fas fa-clock"></i> ìë™ ì‹¤í–‰ ìƒíƒœ:</strong>
                                <span id="ai-scheduler-status"
                                    class="badge {% if ai_scheduler_status.enabled %}bg-success{% else %}bg-secondary{% endif %} ms-2">{%
                                    if ai_scheduler_status.enabled %}í™œì„±í™”{% else %}ë¹„í™œì„±í™”{% endif %}</span>
                                <span id="ai-scheduler-interval" class="text-muted ms-2">{% if
                                    ai_scheduler_status.enabled %}({{ ai_scheduler_status.interval_minutes }}ë¶„ë§ˆë‹¤){%
                                    endif %}</span>
                                <div class="mt-1">
                                    <small class="text-muted">ë§ˆì§€ë§‰ ì‹¤í–‰: <span id="ai-last-execution">{% if
                                            ai_scheduler_status.last_execution %}{{ ai_scheduler_status.last_execution
                                            }}{% else %}-{% endif %}</span></small>
                                </div>
                            </div>
                            <div>
                                <input type="number" id="ai-interval-input"
                                    class="form-control form-control-sm d-inline-block" style="width: 80px;" min="5"
                                    max="1440" value="{{ ai_scheduler_status.interval_minutes }}" placeholder="ë¶„">
                                <button class="btn btn-sm btn-outline-primary ms-2" onclick="updateAIInterval()">
                                    <i class="fas fa-save"></i> ì €ì¥
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-chart-line"></i> ì‹œì¥ ë¶„ì„
                                    <span id="market-mock-badge" class="badge bg-warning ms-2"
                                        style="display: none;">ëª¨ì˜ì‘ë‹µ</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">ì‹ ë¢°ë„</small>
                                    <span id="market-confidence" class="badge bg-secondary">0%</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">ë¦¬ìŠ¤í¬ ë ˆë²¨</small>
                                    <span id="market-risk" class="badge bg-warning">Medium</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <small class="text-muted">ë¶„ì„ ì‹œê°„</small>
                                    <small id="market-analysis-timestamp" class="text-info">-</small>
                                </div>
                                <div id="market-analysis-content" class="analysis-content">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-brain"></i>
                                        <p class="mt-2">AI ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì‹œì¥ ë¶„ì„ì„ ì‹¤í–‰í•˜ì„¸ìš”</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-0 bg-light">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">
                                    <i class="fas fa-lightbulb"></i> ê±°ë˜ ì¡°ì–¸
                                    <span id="trading-mock-badge" class="badge bg-warning ms-2"
                                        style="display: none;">ëª¨ì˜ì‘ë‹µ</span>
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">ì‹ ë¢°ë„</small>
                                    <span id="trading-confidence" class="badge bg-secondary">0%</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">ë¶„ì„ ì‹œê°„</small>
                                    <small id="trading-advice-timestamp" class="text-info">-</small>
                                </div>
                                <div id="trading-recommendations" class="mb-3">
                                    <!-- ê¶Œì¥ì‚¬í•­ íƒœê·¸ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </div>
                                <div id="trading-advice-content" class="analysis-content">
                                    <div class="text-center text-muted">
                                        <i class="fas fa-lightbulb"></i>
                                        <p class="mt-2">AI ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ê±°ë˜ ì¡°ì–¸ì„ ì‹¤í–‰í•˜ì„¸ìš”</p>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    <i class="fas fa-clock"></i>
                                    <span id="trading-timestamp">-</span>
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ìµœê·¼ í™œë™ -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-history text-info"></i> ìµœê·¼ ê±°ë˜</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/trades'">
                    ì „ì²´ ë³´ê¸°
                </button>
            </div>
            <div class="card-body">
                <div id="recent-trades">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <div>ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-bell text-warning"></i> ì‹œìŠ¤í…œ ë¡œê·¸</h5>
                <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/logs'">
                    ì „ì²´ ë³´ê¸°
                </button>
            </div>
            <div class="card-body">
                <div id="recent-logs">
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-file-alt fa-2x mb-2"></i>
                        <div>ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ JavaScript -->
<script>
    // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜ (ì„œë²„ ì‹œê°„ ê¸°ì¤€)
    function updateNextExecutionTime(nextExecutionStr, isRunning, element, serverTimeStr) {
        if (!element) {
            console.error('next-execution ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }

        console.log('ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì²˜ë¦¬:', {
            next_execution: nextExecutionStr,
            server_time: serverTimeStr,
            type: typeof nextExecutionStr,
            isRunning: isRunning
        });

        if (!nextExecutionStr) {
            element.textContent = isRunning ? 'ê³„ì‚°ì¤‘...' : 'ì •ì§€ë¨';
            console.log('next_executionì´ null/undefined - ê¸°ë³¸ê°’ í‘œì‹œ');
            return;
        }

        try {
            // ë‹¤ì–‘í•œ ì‹œê°„ í˜•ì‹ ì²˜ë¦¬
            let nextTime, serverTime;

            // ISO ë¬¸ìì—´ì¸ ê²½ìš° (ì˜ˆ: "2025-08-31T15:12:02.230202")
            if (typeof nextExecutionStr === 'string') {
                // Zê°€ ì—†ìœ¼ë©´ ë¡œì»¬ ì‹œê°„ìœ¼ë¡œ ì²˜ë¦¬ë˜ë¯€ë¡œ KST ì²˜ë¦¬
                if (!nextExecutionStr.includes('Z') && !nextExecutionStr.includes('+')) {
                    nextTime = new Date(nextExecutionStr + '+09:00'); // KST ëª…ì‹œ
                } else {
                    nextTime = new Date(nextExecutionStr);
                }
            } else {
                nextTime = new Date(nextExecutionStr);
            }

            // ì„œë²„ ì‹œê°„ íŒŒì‹± (ì„œë²„ ì‹œê°„ì´ ì œê³µëœ ê²½ìš°)
            if (serverTimeStr) {
                if (typeof serverTimeStr === 'string') {
                    if (!serverTimeStr.includes('Z') && !serverTimeStr.includes('+')) {
                        serverTime = new Date(serverTimeStr + '+09:00');
                    } else {
                        serverTime = new Date(serverTimeStr);
                    }
                } else {
                    serverTime = new Date(serverTimeStr);
                }
            } else {
                serverTime = new Date(); // fallback to local time
            }

            console.log('íŒŒì‹±ëœ ì‹œê°„:', nextTime, 'isValid:', !isNaN(nextTime.getTime()));
            console.log('ì„œë²„ ì‹œê°„:', serverTime, 'isValid:', !isNaN(serverTime.getTime()));

            if (!isNaN(nextTime.getTime()) && !isNaN(serverTime.getTime())) {
                // ì„œë²„ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
                const diff = nextTime - serverTime;
                console.log('ì„œë²„ ê¸°ì¤€ ì‹œê°„ ì°¨ì´:', diff, 'ms');

                // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥ (ì¹´ìš´íŠ¸ë‹¤ìš´ ìš©) - ë¡œì»¬ ì‹œê°„ ê¸°ì¤€ìœ¼ë¡œ ì¡°ì •
                const localAdjustedTime = new Date(Date.now() + diff);
                globalNextExecutionTime = localAdjustedTime;

                if (diff > 0) {
                    // ë¯¸ë˜ ì‹œê°„ì¸ ê²½ìš° - í•œêµ­ ì‹œê°„ìœ¼ë¡œ í‘œì‹œ
                    const timeStr = nextTime.toLocaleTimeString('ko-KR', {
                        timeZone: 'Asia/Seoul',
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });

                    // ë‚¨ì€ ì‹œê°„ ê³„ì‚° (ë¶„:ì´ˆ)
                    const remainingMinutes = Math.floor(diff / 60000);
                    const remainingSeconds = Math.floor((diff % 60000) / 1000);
                    const remainingStr = `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`;

                    element.textContent = `${timeStr} (${remainingStr}í›„)`;
                    console.log('í‘œì‹œëœ ì‹œê°„:', timeStr, 'ë‚¨ì€ì‹œê°„:', remainingStr);
                } else {
                    // ê³¼ê±° ì‹œê°„ì¸ ê²½ìš°
                    element.textContent = isRunning ? 'ê³§ ì‹¤í–‰...' : 'ì •ì§€ë¨';
                    globalNextExecutionTime = null; // ê³¼ê±° ì‹œê°„ì´ë©´ ë¦¬ì…‹
                    console.log('ê³¼ê±° ì‹œê°„ - ê³§ ì‹¤í–‰ í‘œì‹œ');
                }
            } else {
                element.textContent = isRunning ? 'ê³„ì‚°ì¤‘...' : 'ì •ì§€ë¨';
                console.log('ì‹œê°„ íŒŒì‹± ì‹¤íŒ¨ - ê¸°ë³¸ê°’ í‘œì‹œ');
            }
        } catch (e) {
            console.error('ì‹œê°„ íŒŒì‹± ì˜¤ë¥˜:', e, 'next_execution:', nextExecutionStr);
            element.textContent = isRunning ? 'ê³„ì‚°ì¤‘...' : 'ì •ì§€ë¨';
        }
    }

    // ì „ì—­ ë³€ìˆ˜ë¡œ ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì €ì¥
    let globalNextExecutionTime = null;



    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateCountdown() {
        const nextExecution = document.getElementById('next-execution');
        if (!nextExecution || !globalNextExecutionTime) {
            return;
        }

        try {
            const now = new Date();
            const diff = globalNextExecutionTime - now;

            if (diff > 0) {
                // ë¯¸ë˜ ì‹œê°„ì¸ ê²½ìš° - ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸
                const timeStr = globalNextExecutionTime.toLocaleTimeString('ko-KR', {
                    timeZone: 'Asia/Seoul',
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });

                // ë‚¨ì€ ì‹œê°„ ê³„ì‚° (ë¶„:ì´ˆ)
                const remainingMinutes = Math.floor(diff / 60000);
                const remainingSeconds = Math.floor((diff % 60000) / 1000);
                const remainingStr = `${remainingMinutes}:${remainingSeconds.toString().padStart(2, '0')}`;

                nextExecution.textContent = `${timeStr} (${remainingStr}í›„)`;
            } else {
                // ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ê³§ ì‹¤í–‰ í‘œì‹œ
                nextExecution.textContent = 'ê³§ ì‹¤í–‰...';
                globalNextExecutionTime = null; // ë¦¬ì…‹
            }
        } catch (e) {
            console.error('ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', e);
        }
    }

    // ğŸš€ ìƒˆë¡œìš´ ë‹¨ìˆœ í•¨ìˆ˜: ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ë§Œ ì—…ë°ì´íŠ¸
    async function updateNextExecutionOnly() {
        console.log('ğŸ¯ updateNextExecutionOnly ì‹œì‘!');

        try {
            console.log('API í˜¸ì¶œ ì¤‘...');
            const response = await fetch('/api/auto_trading_status');
            console.log('ì‘ë‹µ ìƒíƒœ:', response.status);

            const data = await response.json();
            console.log('ë°›ì€ ë°ì´í„°:', data);

            if (data.status && data.status.next_execution && data.status.server_time) {
                console.log('ì‹œê°„ ê³„ì‚° ì‹œì‘...');
                const nextTime = new Date(data.status.next_execution);
                const serverTime = new Date(data.status.server_time);
                const diff = Math.max(0, (nextTime - serverTime) / 1000);

                console.log('ë‹¤ìŒ ì‹¤í–‰:', nextTime.toLocaleTimeString());
                console.log('ì„œë²„ ì‹œê°„:', serverTime.toLocaleTimeString());
                console.log('ë‚¨ì€ ì‹œê°„(ì´ˆ):', diff);

                const element = document.getElementById('next-execution');
                if (element) {
                    if (diff > 0) {
                        const minutes = Math.floor(diff / 60);
                        const seconds = Math.floor(diff % 60);
                        element.textContent = `${nextTime.toLocaleTimeString()} (${minutes}:${seconds.toString().padStart(2, '0')}í›„)`;
                        console.log('âœ… ì‹œê°„ í‘œì‹œ ì™„ë£Œ!');
                    } else {
                        element.textContent = 'ê³§ ì‹¤í–‰...';
                    }
                } else {
                    console.error('next-execution ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                }
            } else {
                console.error('í•„ìš”í•œ ë°ì´í„° ì—†ìŒ:', data);
            }
        } catch (error) {
            console.error('ğŸš¨ ì˜¤ë¥˜:', error);
            alert('ì˜¤ë¥˜: ' + error.message);
        }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function () {
        console.log('=== ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™” ì‹œì‘ ===');

        // ìƒˆë¡œìš´ ë‹¨ìˆœ í•¨ìˆ˜ ì‚¬ìš©
        console.log('ìƒˆë¡œìš´ í•¨ìˆ˜ í…ŒìŠ¤íŠ¸...');
        updateNextExecutionOnly();

        setTimeout(() => {
            console.log('2ì´ˆ í›„ ì¬ì‹¤í–‰...');
            updateNextExecutionOnly();
        }, 2000);

        // 30ì´ˆë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸ (ìƒˆë¡œìš´ í•¨ìˆ˜ ì‚¬ìš©)
        try {
            setInterval(updateNextExecutionOnly, 30000);
            console.log('30ì´ˆ ìë™ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì„¤ì • ì™„ë£Œ');
        } catch (e) {
            console.error('ìë™ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì„¤ì • ì‹¤íŒ¨:', e);
        }

        console.log('ìë™ ì—…ë°ì´íŠ¸ íƒ€ì´ë¨¸ ì„¤ì • ì™„ë£Œ');
    });

    // ì²´ì œ ì •ë³´ ì—…ë°ì´íŠ¸
    async function updateRegimeStatus() {
        try {
            const response = await fetch('/api/regime/status');
            const data = await response.json();
            
            if (data.success && data.regime_info.status === 'active') {
                const regimeInfo = data.regime_info;
                
                // í˜„ì¬ ì²´ì œ í‘œì‹œ
                const regimeElement = document.getElementById('current-regime');
                if (regimeElement) {
                    const regimeText = getRegimeDisplayName(regimeInfo.regime);
                    regimeElement.textContent = regimeText;
                    regimeElement.className = 'fw-bold ' + getRegimeColorClass(regimeInfo.regime);
                }
                
                // ì‹ ë¢°ë„ í‘œì‹œ
                const confidenceElement = document.getElementById('regime-confidence');
                if (confidenceElement) {
                    const confidence = (regimeInfo.confidence * 100).toFixed(1);
                    confidenceElement.textContent = confidence + '%';
                    confidenceElement.className = 'fw-bold ' + getConfidenceColorClass(regimeInfo.confidence);
                }
                
                // íŒë‹¨ ê·¼ê±° í‘œì‹œ
                const reasoningElement = document.getElementById('regime-reasoning');
                if (reasoningElement) {
                    reasoningElement.textContent = regimeInfo.reasoning || '-';
                }
                
                // ì£¼ìš” ì§€í‘œ í‘œì‹œ
                if (regimeInfo.metrics) {
                    const rsiElement = document.getElementById('regime-rsi');
                    if (rsiElement) {
                        rsiElement.textContent = regimeInfo.metrics.rsi ? regimeInfo.metrics.rsi.toFixed(1) : '-';
                    }
                    
                    const atrElement = document.getElementById('regime-atr');
                    if (atrElement) {
                        atrElement.textContent = regimeInfo.metrics.atr ? (regimeInfo.metrics.atr / 1000000).toFixed(2) + 'M' : '-';
                    }
                    
                    const volumeElement = document.getElementById('regime-volume');
                    if (volumeElement) {
                        volumeElement.textContent = regimeInfo.metrics.volume_ratio ? regimeInfo.metrics.volume_ratio.toFixed(2) + 'x' : '-';
                    }
                }
                
                console.log('ì²´ì œ ì •ë³´ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', regimeInfo.regime);
            } else {
                console.warn('ì²´ì œ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', data);
                // ì˜¤ë¥˜ ìƒíƒœ í‘œì‹œ
                const regimeElement = document.getElementById('current-regime');
                if (regimeElement) {
                    regimeElement.textContent = 'ì˜¤ë¥˜';
                    regimeElement.className = 'fw-bold text-danger';
                }
            }
        } catch (error) {
            console.error('ì²´ì œ ì •ë³´ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
        }
    }
    
    // ì²´ì œ í‘œì‹œëª… ë³€í™˜
    function getRegimeDisplayName(regime) {
        const regimeNames = {
            'bull_market': 'ìƒìŠ¹ì¥',
            'bear_market': 'í•˜ë½ì¥',
            'sideways': 'íš¡ë³´ì¥',
            'high_volatility': 'ê³ ë³€ë™ì„±',
            'low_volatility': 'ì €ë³€ë™ì„±',
            'trending_up': 'ìƒìŠ¹ íŠ¸ë Œë“œ',
            'trending_down': 'í•˜ë½ íŠ¸ë Œë“œ',
            'unknown': 'ë¶ˆëª…í™•'
        };
        return regimeNames[regime] || regime;
    }
    
    // ì²´ì œë³„ ìƒ‰ìƒ í´ë˜ìŠ¤
    function getRegimeColorClass(regime) {
        const colorClasses = {
            'bull_market': 'text-success',
            'bear_market': 'text-danger',
            'sideways': 'text-warning',
            'high_volatility': 'text-danger',
            'low_volatility': 'text-info',
            'trending_up': 'text-success',
            'trending_down': 'text-danger',
            'unknown': 'text-secondary'
        };
        return colorClasses[regime] || 'text-primary';
    }
    
    // ì‹ ë¢°ë„ë³„ ìƒ‰ìƒ í´ë˜ìŠ¤
    function getConfidenceColorClass(confidence) {
        if (confidence >= 0.8) return 'text-success';
        if (confidence >= 0.6) return 'text-warning';
        return 'text-danger';
    }

    // í†µí•© ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    async function updateDashboard() {
        console.log('=== updateDashboard í•¨ìˆ˜ ì‹œì‘ ===');

        try {
            console.log('API í˜¸ì¶œ ì¤€ë¹„ ì¤‘...');

            // ìš°ì„  auto_trading_statusë§Œ í˜¸ì¶œí•´ì„œ next_execution í™•ì¸
            console.log('auto_trading_status API í˜¸ì¶œ...');
            const autoTraderResponse = await fetch('/api/auto_trading_status');
            console.log('auto_trading_status ì‘ë‹µ ìˆ˜ì‹ :', autoTraderResponse.status);

            const autoTraderData = await autoTraderResponse.json();
            console.log('auto_trading_status ë°ì´í„°:', autoTraderData);

            // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸ (ìµœìš°ì„ )
            console.log('ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œë„...');
            updateAutoTraderStatus(autoTraderData);
            
            // ì‹œìŠ¤í…œ ìƒíƒœì— í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í†µí•© ì—…ë°ì´íŠ¸
            console.log('ì‹œìŠ¤í…œ ìƒíƒœ í†µí•© ì—…ë°ì´íŠ¸ ì‹œë„...');
            updateSystemStatusWithProcess();
            
            // ì²´ì œ ì •ë³´ ì—…ë°ì´íŠ¸
            console.log('ì²´ì œ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹œë„...');
            updateRegimeStatus();

            // ë‚˜ë¨¸ì§€ APIë“¤ì€ ì ì‹œ ì£¼ì„ ì²˜ë¦¬
            /*
            const [systemResponse, balanceResponse, tradesResponse, strategyResponse] = await Promise.all([
                fetch('/api/system/status'),
                fetch('/api/balance'),
                fetch('/api/trades?limit=5'),
                fetch('/api/strategy_analytics/summary?days=7')
            ]);

            const systemData = await systemResponse.json();
            const balanceData = await balanceResponse.json();
            const tradesData = await tradesResponse.json();
            const strategyData = await strategyResponse.json();

            // ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
            updateSystemTradingBadges(systemData);
            // ì”ê³  ì •ë³´ ì—…ë°ì´íŠ¸
            updateBalanceInfo(balanceData);
            // ìµœê·¼ ê±°ë˜ ì—…ë°ì´íŠ¸
            updateRecentTrades(tradesData);
            // ì „ëµ ì„±ê³¼ ì—…ë°ì´íŠ¸
            updateStrategyPerformance(strategyData);
            // AI ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAISchedulerStatus();
            */

            console.log('âœ… ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');

        } catch (error) {
            console.error('ğŸš¨ updateDashboard ì˜¤ë¥˜ ë°œìƒ!');
            console.error('ì˜¤ë¥˜ ê°ì²´:', error);
            console.error('ì˜¤ë¥˜ ë©”ì‹œì§€:', error.message);
            console.error('ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);

            // ì‚¬ìš©ìì—ê²Œë„ ì•Œë¦¼
            alert('ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: ' + error.message);

            // next_execution ìš”ì†Œì— ì˜¤ë¥˜ í‘œì‹œ
            const nextExecElement = document.getElementById('next-execution');
            if (nextExecElement) {
                nextExecElement.textContent = 'ì˜¤ë¥˜ ë°œìƒ';
            }
        }
    }

    function updateSystemTradingBadges(systemData) {
        const sysBadge = document.getElementById('system-enabled-badge');
        const trgBadge = document.getElementById('trading-enabled-badge');
        const sysBtn = document.getElementById('system-toggle-btn');
        const sysIcon = document.getElementById('system-btn-icon');
        const sysText = document.getElementById('system-btn-text');
        const trgBtn = document.getElementById('trading-toggle-btn');
        const trgIcon = document.getElementById('trading-btn-icon');
        const trgText = document.getElementById('trading-btn-text');

        if (systemData.system_enabled) {
            sysBadge.className = 'badge bg-success';
            sysBadge.textContent = 'í™œì„±í™”';
            sysBtn.className = 'btn btn-warning control-btn me-2';
            sysIcon.className = 'fas fa-pause me-2';
            sysText.textContent = 'ì‹œìŠ¤í…œì •ì§€';
        } else {
            sysBadge.className = 'badge bg-secondary';
            sysBadge.textContent = 'ë¹„í™œì„±í™”';
            sysBtn.className = 'btn btn-secondary control-btn me-2';
            sysIcon.className = 'fas fa-power-off me-2';
            sysText.textContent = 'ì‹œìŠ¤í…œì‹œì‘';
        }

        if (systemData.trading_enabled) {
            trgBadge.className = 'badge bg-success';
            trgBadge.textContent = 'í™œì„±í™”';
            trgBtn.className = 'btn btn-warning control-btn';
            trgIcon.className = 'fas fa-pause me-2';
            trgText.textContent = 'ê±°ë˜ì •ì§€';
        } else {
            trgBadge.className = 'badge bg-secondary';
            trgBadge.textContent = 'ë¹„í™œì„±í™”';
            trgBtn.className = 'btn btn-primary control-btn';
            trgIcon.className = 'fas fa-play me-2';
            trgText.textContent = 'ê±°ë˜ì‹œì‘';
        }
    }

    // ì‹œìŠ¤í…œ ìƒíƒœ ë°°ì§€ì— í”„ë¡œì„¸ìŠ¤ ìƒíƒœ í†µí•© ì—…ë°ì´íŠ¸
    async function updateSystemStatusWithProcess() {
        try {
            const response = await fetch('/api/system/process_status');
            const data = await response.json();
            
            const sysBadge = document.getElementById('system-enabled-badge');
            if (!sysBadge) return;

            if (data.success && data.auto_trader_process) {
                const process = data.auto_trader_process;
                
                if (process.running) {
                    // í”„ë¡œì„¸ìŠ¤ê°€ ì‹¤í–‰ ì¤‘ì´ë©´ ì‹œìŠ¤í…œ ìƒíƒœë¥¼ í™œì„±í™”ë¡œ í‘œì‹œ
                    sysBadge.className = 'badge bg-success';
                    sysBadge.textContent = 'í™œì„±í™”';
                    
                    if (process.detection_method === 'internal') {
                        const internal = process.internal_status;
                        sysBadge.title = `ì‹œìŠ¤í…œ í™œì„±í™” + í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ì¤‘ (ë‚´ë¶€) - ì´ ì‹¤í–‰: ${internal.total_executions || 0}íšŒ`;
                    } else {
                        const external = process.external_process;
                        sysBadge.title = `ì‹œìŠ¤í…œ í™œì„±í™” + í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ì¤‘ (PID: ${external.pid}) - CPU: ${external.cpu_percent}%, ë©”ëª¨ë¦¬: ${external.memory_mb}MB`;
                    }
                } else {
                    // í”„ë¡œì„¸ìŠ¤ê°€ ì¤‘ë‹¨ë˜ì—ˆìœ¼ë©´ ê²½ê³  ìƒíƒœë¡œ í‘œì‹œ
                    sysBadge.className = 'badge bg-warning';
                    sysBadge.textContent = 'í”„ë¡œì„¸ìŠ¤ ì¤‘ë‹¨';
                    
                    const internal = process.internal_status;
                    const external = process.external_process;
                    
                    if (internal && !internal.running && external && !external.running) {
                        sysBadge.title = `ì‹œìŠ¤í…œì€ í™œì„±í™”ë˜ì–´ ìˆì§€ë§Œ í”„ë¡œì„¸ìŠ¤ê°€ ì¤‘ë‹¨ë¨ - ë‚´ë¶€: ${internal.reason}, ì™¸ë¶€: ${external.reason}`;
                    } else if (internal && !internal.running) {
                        sysBadge.title = `ì‹œìŠ¤í…œì€ í™œì„±í™”ë˜ì–´ ìˆì§€ë§Œ ë‚´ë¶€ í”„ë¡œì„¸ìŠ¤ ì¤‘ë‹¨: ${internal.reason}`;
                    } else {
                        sysBadge.title = `ì‹œìŠ¤í…œì€ í™œì„±í™”ë˜ì–´ ìˆì§€ë§Œ ì™¸ë¶€ í”„ë¡œì„¸ìŠ¤ ì¤‘ë‹¨: ${external.reason}`;
                    }
                }
            } else {
                // API ì˜¤ë¥˜ ì‹œ ê¸°ë³¸ ìƒíƒœ ìœ ì§€
                sysBadge.className = 'badge bg-secondary';
                sysBadge.textContent = 'í™•ì¸ë¶ˆê°€';
                sysBadge.title = 'í”„ë¡œì„¸ìŠ¤ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
        } catch (error) {
            console.error('ì‹œìŠ¤í…œ ìƒíƒœ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            const sysBadge = document.getElementById('system-enabled-badge');
            if (sysBadge) {
                sysBadge.className = 'badge bg-warning';
                sysBadge.textContent = 'ì˜¤ë¥˜';
                sysBadge.title = 'ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }
    }


    // AutoTrader ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateAutoTraderStatus(data) {
        console.log('=== updateAutoTraderStatus í˜¸ì¶œë¨ ===');
        console.log('ë°›ì€ ë°ì´í„°:', data);

        if (!data || !data.status) {
            console.error('Invalid data received:', data);
            return;
        }

        const status = data.status;
        const isRunning = status.running;

        console.log('AutoTrader ìƒíƒœ ì—…ë°ì´íŠ¸:', {
            running: isRunning,
            next_execution: status.next_execution,
            auto_trading_enabled: status.auto_trading_enabled,
            system_enabled: status.system_enabled,
            timestamp: new Date().toLocaleTimeString()
        });

        // ìƒíƒœ í‘œì‹œê¸° ì—…ë°ì´íŠ¸
        const statusIndicator = document.getElementById('system-status');
        const statusBadge = document.getElementById('auto-trader-status');
        const button = document.getElementById('auto-trader-btn');
        const btnIcon = document.getElementById('btn-icon');
        const btnText = document.getElementById('btn-text');

        console.log('Elements found:', {
            statusIndicator: !!statusIndicator,
            statusBadge: !!statusBadge,
            button: !!button,
            btnIcon: !!btnIcon,
            btnText: !!btnText
        });

        if (isRunning) {
            statusIndicator.className = 'status-indicator status-active pulse-animation';
            statusBadge.className = 'badge bg-success';
            statusBadge.textContent = 'ì‹¤í–‰ì¤‘';
            button.className = 'btn btn-warning control-btn';
            btnIcon.className = 'fas fa-pause me-2';
            btnText.textContent = 'ì •ì§€';
            button.setAttribute('data-running', 'true');
        } else {
            statusIndicator.className = 'status-indicator status-inactive';
            statusBadge.className = 'badge bg-secondary';
            statusBadge.textContent = 'ì •ì§€ë¨';
            button.className = 'btn btn-primary control-btn';
            btnIcon.className = 'fas fa-play me-2';
            btnText.textContent = 'ì‹œì‘';
            button.setAttribute('data-running', 'false');
        }

        // ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸
        const nextExecution = document.getElementById('next-execution');
        console.log('ë‹¤ìŒ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸ ì‹œë„:', {
            element: nextExecution,
            elementFound: !!nextExecution,
            nextExecutionValue: status.next_execution,
            isRunning: isRunning
        });

        if (nextExecution) {
            updateNextExecutionTime(status.next_execution, isRunning, nextExecution, status.server_time);
        } else {
            console.error('next-execution ì—˜ë¦¬ë¨¼íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }

        // ì„±ê³µë¥ 
        const successRateDisplay = document.getElementById('success-rate-display');
        if (successRateDisplay && typeof status.success_rate === 'number') {
            successRateDisplay.textContent = `${status.success_rate.toFixed(1)}%`;
        }

        // ì´ ì‹¤í–‰ íšŸìˆ˜
        const totalExecutionsElement = document.getElementById('total-executions');
        if (totalExecutionsElement) {
            totalExecutionsElement.textContent = status.total_executions || 0;
        }
    }

    // ì”ê³  ì •ë³´ ì—…ë°ì´íŠ¸
    function updateBalanceInfo(data) {
        if (data.success) {
            const balance = data.balance;
            document.getElementById('total-balance').textContent =
                `â‚© ${Number(balance.total_krw).toLocaleString()}`;
        }
    }

    // ìµœê·¼ ê±°ë˜ ì—…ë°ì´íŠ¸
    function updateRecentTrades(data) {
        const container = document.getElementById('recent-trades');

        if (data.success && data.trades.length > 0) {
            container.innerHTML = data.trades.map(trade => `
            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                <div>
                    <div class="fw-bold ${trade.side === 'buy' ? 'text-success' : 'text-danger'}">
                        ${trade.side === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„'} 
                        ${Number(trade.quantity).toFixed(8)} BTC
                    </div>
                    <small class="text-muted">${formatKST(trade.entry_time)}</small>
                </div>
                <div class="text-end">
                    <div class="fw-bold">â‚© ${Number(trade.amount).toLocaleString()}</div>
                    <small class="text-muted">${trade.strategy_id}</small>
                </div>
            </div>
        `).join('');
        } else {
            container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <div>ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</div>
            </div>
        `;
        }
    }

    function updateStrategyPerformance(data) {
        if (!data.success || !data.data) {
            console.log('ì „ëµ ì„±ê³¼ ë°ì´í„° ì—†ìŒ');
            return;
        }

        const summary = data.data;
        const overall = summary.overall || {};
        const byTier = summary.by_tier || {};

        // ì „ì²´ ì„±ê³¼ ì§€í‘œ ì—…ë°ì´íŠ¸
        document.getElementById('strategy-total-executions').textContent = overall.total_executions || 0;
        document.getElementById('strategy-total-signals').textContent = overall.total_signals || 0;

        const avgConfidence = overall.avg_confidence || 0;
        document.getElementById('strategy-avg-confidence').textContent = (avgConfidence * 100).toFixed(1) + '%';

        const successRate = overall.avg_success_rate || 0;
        document.getElementById('strategy-success-rate').textContent = (successRate * 100).toFixed(1) + '%';

        // ê³„ì¸µë³„ ì„±ê³¼ ì—…ë°ì´íŠ¸
        const scalpingData = byTier.scalping || {};
        const trendData = byTier.trend || {};
        const integratedData = byTier.integrated || {};

        document.getElementById('scalping-performance').textContent =
            `ì‹¤í–‰ ${scalpingData.total_executions || 0}íšŒ`;

        document.getElementById('trend-performance').textContent =
            `ì‹¤í–‰ ${trendData.total_executions || 0}íšŒ`;

        document.getElementById('integrated-performance').textContent =
            `ì‹¤í–‰ ${integratedData.total_executions || 0}íšŒ`;

        console.log('ì „ëµ ì„±ê³¼ ì—…ë°ì´íŠ¸ ì™„ë£Œ:', {
            total_executions: overall.total_executions,
            total_signals: overall.total_signals,
            avg_confidence: avgConfidence,
            success_rate: successRate
        });
    }

    // AI ë¶„ì„ ê´€ë ¨ í•¨ìˆ˜ë“¤

    // AI ë¶„ì„ ì¦‰ì‹œ ì‹¤í–‰
    function executeAIAnalysis() {
        fetch('/api/ai/scheduler/execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ì‹¤í–‰ ì„±ê³µ ì‹œ ê²°ê³¼ ë¡œë“œ
                    loadAIAnalysis(true);
                    updateAISchedulerStatus();
                    showNotification('AI ë¶„ì„ì´ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    showNotification(`AI ë¶„ì„ ì‹¤í–‰ ì‹¤íŒ¨: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('AI ë¶„ì„ ì‹¤í–‰ ì˜¤ë¥˜:', error);
                showNotification('AI ë¶„ì„ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
    }

    // AI ìŠ¤ì¼€ì¤„ëŸ¬ í† ê¸€
    function toggleAIScheduler() {
        fetch('/api/ai/scheduler/toggle', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'toggle'
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateAISchedulerStatus();
                    showNotification(data.message, 'success');
                } else {
                    showNotification(`ìŠ¤ì¼€ì¤„ëŸ¬ í† ê¸€ ì‹¤íŒ¨: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('AI ìŠ¤ì¼€ì¤„ëŸ¬ í† ê¸€ ì˜¤ë¥˜:', error);
                showNotification('ìŠ¤ì¼€ì¤„ëŸ¬ í† ê¸€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
    }

    // AI ì‹¤í–‰ ì£¼ê¸° ì—…ë°ì´íŠ¸
    function updateAIInterval() {
        const interval = document.getElementById('ai-interval-input').value;
        if (!interval || interval < 5 || interval > 1440) {
            showNotification('ì‹¤í–‰ ì£¼ê¸°ëŠ” 5ë¶„ì—ì„œ 1440ë¶„(24ì‹œê°„) ì‚¬ì´ì—¬ì•¼ í•©ë‹ˆë‹¤.', 'error');
            return;
        }

        fetch('/api/ai/scheduler/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                interval_minutes: parseInt(interval)
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateAISchedulerStatus();
                    showNotification('ì‹¤í–‰ ì£¼ê¸°ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    showNotification(`ì„¤ì • ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                console.error('AI ì£¼ê¸° ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
                showNotification('ì„¤ì • ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            });
    }

    // AI ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateAISchedulerStatus() {
        fetch('/api/ai/scheduler/status')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const status = data.data;

                    // ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ë°°ì§€ ì—…ë°ì´íŠ¸
                    const statusBadge = document.getElementById('ai-scheduler-status');
                    const intervalSpan = document.getElementById('ai-scheduler-interval');
                    const lastExecutionSpan = document.getElementById('ai-last-execution');
                    const schedulerBtn = document.getElementById('ai-scheduler-btn');
                    const schedulerText = document.getElementById('ai-scheduler-text');
                    const intervalInput = document.getElementById('ai-interval-input');

                    if (status.enabled) {
                        statusBadge.className = 'badge bg-success ms-2';
                        statusBadge.textContent = 'í™œì„±í™”';
                        intervalSpan.textContent = `(${status.interval_minutes}ë¶„ë§ˆë‹¤)`;
                        schedulerBtn.className = 'btn btn-sm btn-success me-2';
                        schedulerText.textContent = 'ìë™ ì‹¤í–‰ ì¤‘';
                    } else {
                        statusBadge.className = 'badge bg-secondary ms-2';
                        statusBadge.textContent = 'ë¹„í™œì„±í™”';
                        intervalSpan.textContent = '';
                        schedulerBtn.className = 'btn btn-sm btn-outline-secondary me-2';
                        schedulerText.textContent = 'ìë™ ì‹¤í–‰';
                    }

                    // ë§ˆì§€ë§‰ ì‹¤í–‰ ì‹œê°„ ì—…ë°ì´íŠ¸
                    if (status.last_execution) {
                        lastExecutionSpan.textContent = formatKST(status.last_execution);
                    } else {
                        lastExecutionSpan.textContent = '-';
                    }

                    // ì‹¤í–‰ ì£¼ê¸° ì…ë ¥ë€ ì—…ë°ì´íŠ¸
                    intervalInput.value = status.interval_minutes;
                }
            })
            .catch(error => {
                console.error('AI ìŠ¤ì¼€ì¤„ëŸ¬ ìƒíƒœ ì¡°íšŒ ì˜¤ë¥˜:', error);
            });
    }

    // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
    function showNotification(message, type = 'info') {
        // ê°„ë‹¨í•œ ì•Œë¦¼ (ë‚˜ì¤‘ì— Toast ë¼ì´ë¸ŒëŸ¬ë¦¬ë¡œ ê°œì„  ê°€ëŠ¥)
        const alertClass = type === 'success' ? 'alert-success' :
            type === 'error' ? 'alert-danger' : 'alert-info';

        const notification = document.createElement('div');
        notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;

        document.body.appendChild(notification);

        // 3ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    function loadAIAnalysis(forceRefresh = false) {
        const refreshParam = forceRefresh ? '?refresh=true' : '';

        // ì‹œì¥ ë¶„ì„ ë¡œë“œ (íƒ€ì„ì•„ì›ƒ 3ë¶„)
        const controller1 = new AbortController();
        const timeoutId1 = setTimeout(() => controller1.abort(), 180000); // 3ë¶„ íƒ€ì„ì•„ì›ƒ

        fetch(`/api/ai/market_analysis${refreshParam}`, {
            signal: controller1.signal
        })
            .then(response => {
                clearTimeout(timeoutId1);
                return response.json();
            })
            .then(data => updateMarketAnalysis(data))
            .catch(error => {
                clearTimeout(timeoutId1);
                console.error('ì‹œì¥ ë¶„ì„ ë¡œë“œ ì˜¤ë¥˜:', error);
                updateMarketAnalysis({ success: false, error: error.message });
            });

        // ê±°ë˜ ì¡°ì–¸ ë¡œë“œ (íƒ€ì„ì•„ì›ƒ 3ë¶„)
        const controller2 = new AbortController();
        const timeoutId2 = setTimeout(() => controller2.abort(), 180000); // 3ë¶„ íƒ€ì„ì•„ì›ƒ

        fetch(`/api/ai/trading_advice${refreshParam}`, {
            signal: controller2.signal
        })
            .then(response => {
                clearTimeout(timeoutId2);
                return response.json();
            })
            .then(data => updateTradingAdvice(data))
            .catch(error => {
                clearTimeout(timeoutId2);
                console.error('ê±°ë˜ ì¡°ì–¸ ë¡œë“œ ì˜¤ë¥˜:', error);
                updateTradingAdvice({ success: false, error: error.message });
            });
    }

    function updateMarketAnalysis(data) {
        const contentElement = document.getElementById('market-analysis-content');
        const confidenceElement = document.getElementById('market-confidence');
        const riskElement = document.getElementById('market-risk');
        const timestampElement = document.getElementById('market-analysis-timestamp');

        if (data.success && data.data) {
            const analysis = data.data;

            // ì‹ ë¢°ë„ ì—…ë°ì´íŠ¸
            const confidence = Math.round(analysis.confidence * 100);
            confidenceElement.textContent = `${confidence}%`;
            confidenceElement.className = `badge ${confidence >= 70 ? 'bg-success' : confidence >= 50 ? 'bg-warning' : 'bg-danger'}`;

            // ë¦¬ìŠ¤í¬ ë ˆë²¨ ì—…ë°ì´íŠ¸
            riskElement.textContent = analysis.risk_level.toUpperCase();
            riskElement.className = `badge ${analysis.risk_level === 'low' ? 'bg-success' : analysis.risk_level === 'high' ? 'bg-danger' : 'bg-warning'}`;

            // ë¶„ì„ ë‚´ìš© ì—…ë°ì´íŠ¸
            contentElement.innerHTML = `<div class="analysis-text">${analysis.content.replace(/\n/g, '<br>')}</div>`;

            // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
            timestampElement.textContent = formatKST(analysis.timestamp);

            // ëª¨ì˜ì‘ë‹µ ë°°ì§€ í‘œì‹œ
            const mockBadge = document.getElementById('market-mock-badge');
            if (analysis.is_mock) {
                mockBadge.style.display = 'inline';
            } else {
                mockBadge.style.display = 'none';
            }

        } else {
            contentElement.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${data.error || 'ë¶„ì„ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</div>`;
            confidenceElement.textContent = '0%';
            confidenceElement.className = 'badge bg-secondary';
            riskElement.textContent = 'UNKNOWN';
            riskElement.className = 'badge bg-secondary';

            // ì˜¤ë¥˜ ì‹œ ëª¨ì˜ì‘ë‹µ ë°°ì§€ ìˆ¨ê¹€
            document.getElementById('market-mock-badge').style.display = 'none';
        }
    }

    function updateTradingAdvice(data) {
        const contentElement = document.getElementById('trading-advice-content');
        const confidenceElement = document.getElementById('trading-confidence');
        const recommendationsElement = document.getElementById('trading-recommendations');
        const timestampElement = document.getElementById('trading-advice-timestamp');

        if (data.success && data.data) {
            const advice = data.data;

            // ì‹ ë¢°ë„ ì—…ë°ì´íŠ¸
            const confidence = Math.round(advice.confidence * 100);
            confidenceElement.textContent = `${confidence}%`;
            confidenceElement.className = `badge ${confidence >= 70 ? 'bg-success' : confidence >= 50 ? 'bg-warning' : 'bg-danger'}`;

            // ê¶Œì¥ì‚¬í•­ íƒœê·¸ ì—…ë°ì´íŠ¸
            if (advice.recommendations && advice.recommendations.length > 0) {
                recommendationsElement.innerHTML = advice.recommendations.map(rec =>
                    `<span class="badge bg-info me-1 mb-1">${rec}</span>`
                ).join('');
            } else {
                recommendationsElement.innerHTML = '<span class="text-muted">ê¶Œì¥ì‚¬í•­ ì—†ìŒ</span>';
            }

            // ì¡°ì–¸ ë‚´ìš© ì—…ë°ì´íŠ¸
            contentElement.innerHTML = `<div class="analysis-text">${advice.content.replace(/\n/g, '<br>')}</div>`;

            // íƒ€ì„ìŠ¤íƒ¬í”„ ì—…ë°ì´íŠ¸
            timestampElement.textContent = formatKST(advice.timestamp);

            // ëª¨ì˜ì‘ë‹µ ë°°ì§€ í‘œì‹œ
            const mockBadge = document.getElementById('trading-mock-badge');
            if (advice.is_mock) {
                mockBadge.style.display = 'inline';
            } else {
                mockBadge.style.display = 'none';
            }

        } else {
            contentElement.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-triangle"></i> ${data.error || 'ì¡°ì–¸ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</div>`;
            confidenceElement.textContent = '0%';
            confidenceElement.className = 'badge bg-secondary';
            recommendationsElement.innerHTML = '';

            // ì˜¤ë¥˜ ì‹œ ëª¨ì˜ì‘ë‹µ ë°°ì§€ ìˆ¨ê¹€
            document.getElementById('trading-mock-badge').style.display = 'none';
        }
    }

    // KST ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
    function formatKST(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString('ko-KR', {
            timeZone: 'Asia/Seoul',
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }

    // ì‹œìŠ¤í…œ/ê±°ë˜ ì „ìš© ë²„íŠ¼ í•¸ë“¤ëŸ¬
    async function toggleSystemButton() {
        const sysText = document.getElementById('system-btn-text').textContent;
        const action = sysText.includes('ì‹œì‘') ? 'enable' : 'disable';
        const resp = await fetch('/api/system/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action }) });
        const data = await resp.json();
        if (data.success) {
            showAlert('success', data.message);
            // ì‘ë‹µì— ìƒíƒœê°€ í¬í•¨ë˜ë©´ ì¦‰ì‹œ ë°°ì§€ ë°˜ì˜
            if (data.status) {
                updateSystemTradingBadges(data.status);
            }
            setTimeout(updateDashboard, 500);
        } else {
            showAlert('danger', data.message || 'ì‹œìŠ¤í…œ ì „í™˜ ì‹¤íŒ¨');
        }
    }

    async function toggleTradingButton() {
        const trgText = document.getElementById('trading-btn-text').textContent;
        const action = trgText.includes('ì‹œì‘') ? 'enable' : 'disable';
        const resp = await fetch('/api/trading/toggle', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ action }) });
        const data = await resp.json();
        if (data.success) {
            showAlert('success', data.message);
            if (data.status) {
                updateSystemTradingBadges(data.status);
            }
            // ì‹œìŠ¤í…œì€ ì¼œì ¸ ìˆê³  ê±°ë˜ë¥¼ ì¼°ë‹¤ë©´ ì˜¤í† íŠ¸ë ˆì´ë” ì‹œì‘ ì‹œë„
            const sysResp = await fetch('/api/system/status');
            const sys = await sysResp.json();
            if (sys.system_enabled) {
                await fetch('/api/auto_trader/start', { method: 'POST' });
            }
            setTimeout(updateDashboard, 800);
        } else {
            showAlert('danger', data.message || 'ê±°ë˜ ì „í™˜ ì‹¤íŒ¨');
        }
    }

    // AutoTrader í† ê¸€ (ê°œì„ ëœ ì‹œìŠ¤í…œ ìë™ í™œì„±í™” í¬í•¨)
    async function toggleAutoTrader() {
        const button = document.getElementById('auto-trader-btn');
        const isRunning = button.getAttribute('data-running') === 'true';
        const action = isRunning ? 'stop' : 'start';

        console.log('AutoTrader í† ê¸€:', { isRunning, action });

        // ë²„íŠ¼ ë¹„í™œì„±í™” (ì¤‘ë³µ í´ë¦­ ë°©ì§€)
        button.disabled = true;
        const originalText = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ì²˜ë¦¬ì¤‘...';

        try {
            // ì‹œì‘í•˜ë ¤ëŠ” ê²½ìš°, ë¨¼ì € ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
            if (action === 'start') {
                showAlert('info', 'ì‹œìŠ¤í…œ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  í•„ìš”ì‹œ ìë™ í™œì„±í™”í•©ë‹ˆë‹¤...');

                // ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
                const systemResponse = await fetch('/api/system/status');
                const systemData = await systemResponse.json();

                console.log('ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸:', systemData);

                // ì‹œìŠ¤í…œì´ ë¹„í™œì„±í™”ëœ ê²½ìš° ìë™ í™œì„±í™”
                if (!systemData.system_enabled) {
                    console.log('ì‹œìŠ¤í…œ ë¹„í™œì„±í™”ë¨ - ìë™ í™œì„±í™” ì‹œë„');
                    showAlert('warning', 'ì‹œìŠ¤í…œì´ ë¹„í™œì„±í™”ë˜ì–´ ìˆì–´ ë¨¼ì € í™œì„±í™”í•©ë‹ˆë‹¤...');

                    const enableSystemResponse = await fetch('/api/system/toggle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'enable' })
                    });

                    const enableSystemData = await enableSystemResponse.json();

                    if (!enableSystemData.success) {
                        showAlert('danger', 'ì‹œìŠ¤í…œ í™œì„±í™” ì‹¤íŒ¨: ' + enableSystemData.message);
                        return;
                    }

                    console.log('ì‹œìŠ¤í…œ í™œì„±í™” ì™„ë£Œ');
                    showAlert('success', 'ì‹œìŠ¤í…œì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');

                    // 1ì´ˆ ëŒ€ê¸° í›„ ê±°ë˜ í™œì„±í™” ì‹œë„
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }

                // ê±°ë˜ê°€ ë¹„í™œì„±í™”ëœ ê²½ìš° ìë™ í™œì„±í™”
                if (!systemData.trading_enabled) {
                    console.log('ê±°ë˜ ë¹„í™œì„±í™”ë¨ - ìë™ í™œì„±í™” ì‹œë„');
                    showAlert('warning', 'ìë™ê±°ë˜ê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆì–´ ë¨¼ì € í™œì„±í™”í•©ë‹ˆë‹¤...');

                    const enableTradingResponse = await fetch('/api/trading/toggle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'enable' })
                    });

                    const enableTradingData = await enableTradingResponse.json();

                    if (!enableTradingData.success) {
                        showAlert('danger', 'ìë™ê±°ë˜ í™œì„±í™” ì‹¤íŒ¨: ' + enableTradingData.message);
                        return;
                    }

                    console.log('ìë™ê±°ë˜ í™œì„±í™” ì™„ë£Œ');
                    showAlert('success', 'ìë™ê±°ë˜ê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');

                    // 1ì´ˆ ëŒ€ê¸° í›„ AutoTrader ì‹œì‘
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            // AutoTrader í† ê¸€ ì‹¤í–‰
            showAlert('info', `AutoTrader ${action === 'start' ? 'ì‹œì‘' : 'ì •ì§€'} ì¤‘...`);

            const response = await fetch(`/api/auto_trader/${action}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });

            const data = await response.json();

            if (data.success) {
                showAlert('success', data.message);
                // ì¦‰ì‹œ ìƒíƒœ ì—…ë°ì´íŠ¸
                setTimeout(() => {
                    updateDashboard();
                }, 1000);
            } else {
                showAlert('danger', data.message || 'AutoTrader ì œì–´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        } catch (error) {
            console.error('AutoTrader í† ê¸€ ì˜¤ë¥˜:', error);
            showAlert('danger', 'AutoTrader ì œì–´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        } finally {
            // ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
            button.disabled = false;
            button.innerHTML = originalText;
        }
    }

    // ê¸°ì¡´ í•¨ìˆ˜ë“¤ (í˜¸í™˜ì„± ìœ ì§€)
    function analyzeAndExecute() {
        if (confirm('í˜„ì¬ ì‹œì¥ ìƒí™©ì„ ë¶„ì„í•˜ê³  ì‹ í˜¸ì— ë”°ë¼ ê±°ë˜ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            // ë¨¼ì € ë½ ìƒíƒœ í™•ì¸ í›„ í•„ìš”ì‹œ í•´ì œ
            fetch('/api/trading_lock/status')
                .then(response => response.json())
                .then(lockData => {
                    if (lockData.success && lockData.data.locked) {
                        // ë½ì´ ê±¸ë ¤ìˆìœ¼ë©´ í•´ì œ
                        return fetch('/api/trading_lock/release', { method: 'POST' })
                            .then(response => response.json())
                            .then(releaseData => {
                                if (releaseData.success) {
                                    console.log('ê±°ë˜ ë½ ìë™ í•´ì œë¨');
                                    showNotification('ê±°ë˜ ë½ì´ ìë™ìœ¼ë¡œ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                                }
                                return executeAnalysis();
                            });
                    } else {
                        return executeAnalysis();
                    }
                })
                .catch(error => {
                    console.error('ë½ ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
                    // ë½ ìƒíƒœ í™•ì¸ ì‹¤íŒ¨í•´ë„ ë¶„ì„ì€ ì‹œë„
                    executeAnalysis();
                });
        }
    }

    function executeAnalysis() {
        return fetch('/api/manual_trading/execute', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                action: 'analyze_and_execute'
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.analysis) {
                    showAnalysisResults(data.message, data.analysis);
                } else {
                    showAlert(data.success ? 'success' : 'danger', data.message);
                }
                if (data.success) updateDashboard();
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'ë¶„ì„ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
    }

    function showAnalysisResults(message, analysis) {
        let modalHtml = `
            <div class="modal fade" id="analysisModal" tabindex="-1" role="dialog" aria-labelledby="analysisModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="analysisModalLabel">
                                <i class="fas fa-chart-line me-2"></i>ë‹¤ì¸µ ì „ëµ ë¶„ì„ ê²°ê³¼
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-${analysis.executed ? 'success' : 'info'}" role="alert">
                                <strong>${message}</strong>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">í†µí•© ê²°ë¡ </h6>
                                            <h4 class="text-${analysis.consolidated_action === 'buy' ? 'success' : analysis.consolidated_action === 'sell' ? 'danger' : 'secondary'}">
                                                ${analysis.consolidated_action === 'buy' ? 'ë§¤ìˆ˜' : analysis.consolidated_action === 'sell' ? 'ë§¤ë„' : 'í™€ë“œ'}
                                            </h4>
                                            <small class="text-muted">ì‹ ë¢°ë„: ${(analysis.consolidated_confidence * 100).toFixed(1)}%</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-body text-center">
                                            <h6 class="card-title">ë¶„ì„ ì „ëµ</h6>
                                            <h4 class="text-primary">${analysis.strategy_count}ê°œ</h4>
                                            <small class="text-muted">í™œì„± ì „ëµ ë¶„ì„ ì™„ë£Œ</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <h6><i class="fas fa-lightbulb me-2"></i>í†µí•© ë¶„ì„ ê·¼ê±°</h6>
                                <div class="bg-light p-3 rounded">
                                    <small>${analysis.consolidated_reasoning}</small>
                                </div>
                            </div>

                            <h6><i class="fas fa-list me-2"></i>ì „ëµë³„ ì„¸ë¶€ ë¶„ì„</h6>
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>ì „ëµ</th>
                                            <th>ì‹ í˜¸</th>
                                            <th>ì‹ ë¢°ë„</th>
                                            <th>ë¶„ì„ ê·¼ê±°</th>
                                        </tr>
                                    </thead>
                                    <tbody>`;

        analysis.strategy_details.forEach(strategy => {
            const actionBadge = strategy.action === 'buy' ? 'success' : strategy.action === 'sell' ? 'danger' : 'secondary';
            const actionText = strategy.action === 'buy' ? 'ë§¤ìˆ˜' : strategy.action === 'sell' ? 'ë§¤ë„' : 'í™€ë“œ';

            modalHtml += `
                <tr>
                    <td><small>${strategy.strategy_id}</small></td>
                    <td><span class="badge bg-${actionBadge}">${actionText}</span></td>
                    <td><small>${(strategy.confidence * 100).toFixed(1)}%</small></td>
                    <td><small>${strategy.reasoning}</small></td>
                </tr>`;
        });

        modalHtml += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>`;

        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
        document.getElementById('analysisModal')?.remove();
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Bootstrap ëª¨ë‹¬ í‘œì‹œ
        const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
        modal.show();

        // ê°„ë‹¨í•œ ì„±ê³µ ì•Œë¦¼ë„ í‘œì‹œ
        showAlert('success', 'ë¶„ì„ ì™„ë£Œ');
    }

    function manualExecute(action) {
        const actionText = action === 'buy' ? 'ë§¤ìˆ˜' : 'ë§¤ë„';
        if (confirm(`ì •ë§ë¡œ ${actionText}ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            fetch('/api/manual_trading/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action })
            })
                .then(response => response.json())
                .then(data => {
                    showAlert(data.success ? 'success' : 'danger', data.message);
                    if (data.success) updateDashboard();
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', `${actionText} ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`);
                });
        }
    }

    function emergencyStop() {
        if (confirm('âš ï¸ ê¸´ê¸‰ ì •ì§€ë¥¼ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ìë™ê±°ë˜ê°€ ì¦‰ì‹œ ì¤‘ë‹¨ë˜ê³  ì‹œìŠ¤í…œì´ ì•ˆì „ ëª¨ë“œë¡œ ì „í™˜ë©ë‹ˆë‹¤.')) {
            fetch('/api/emergency_stop', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    console.log('ê¸´ê¸‰ì •ì§€ ì‘ë‹µ:', data);

                    if (data.success) {
                        showAlert('warning', 'ê¸´ê¸‰ ì •ì§€ê°€ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.');

                        // ê¸´ê¸‰ì •ì§€ í›„ ìƒíƒœë¥¼ ì¦‰ì‹œ ì •ì§€ë¨ìœ¼ë¡œ ë³€ê²½
                        const statusBadge = document.getElementById('auto-trader-status');
                        const nextExecElement = document.getElementById('next-execution');
                        const button = document.getElementById('auto-trader-btn');
                        const btnIcon = document.getElementById('btn-icon');
                        const btnText = document.getElementById('btn-text');

                        if (statusBadge) {
                            statusBadge.textContent = 'ì •ì§€ë¨';
                            statusBadge.className = 'badge bg-secondary';
                        }

                        if (nextExecElement) {
                            nextExecElement.textContent = 'ì‹œìŠ¤í…œ ì •ì§€ë¨';
                        }

                        if (button) {
                            button.className = 'btn btn-primary control-btn';
                            button.setAttribute('data-running', 'false');
                        }

                        if (btnIcon) {
                            btnIcon.className = 'fas fa-play me-2';
                        }

                        if (btnText) {
                            btnText.textContent = 'ì‹œì‘';
                        }

                        // 2ì´ˆ í›„ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ì™„ì „í•œ ìƒíƒœ ë™ê¸°í™”
                        setTimeout(() => {
                            location.reload();
                        }, 2000);
                    } else {
                        showAlert('danger', 'ê¸´ê¸‰ ì •ì§€ ì‹¤í–‰ ì‹¤íŒ¨: ' + (data.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                    }
                })
                .catch(error => {
                    console.error('ê¸´ê¸‰ì •ì§€ ì˜¤ë¥˜:', error);
                    showAlert('danger', 'ê¸´ê¸‰ ì •ì§€ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
        }
    }

    function showAlert(type, message) {
        // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
        const existingAlert = document.querySelector('.alert');
        if (existingAlert) existingAlert.remove();

        // ìƒˆ ì•Œë¦¼ ìƒì„±
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
        alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;

        document.body.appendChild(alert);

        // 5ì´ˆ í›„ ìë™ ì œê±°
        setTimeout(() => {
            if (alert.parentElement) alert.remove();
        }, 5000);
    }

    // ì‹¤ì‹œê°„ ë¹„íŠ¸ì½”ì¸ ê°€ê²© ì—…ë°ì´íŠ¸
    async function updateBitcoinPrice() {
        try {
            const response = await fetch('/api/market/current_price');
            const result = await response.json();

            if (result.success && result.data) {
                const data = result.data;

                // ê°€ê²© ì—…ë°ì´íŠ¸
                document.getElementById('btc-price').textContent = data.formatted_price;

                // ë³€ë™ë¥  ì •ë³´ ì—…ë°ì´íŠ¸
                const changeElement = document.getElementById('price-change');
                if (data.change_rate !== undefined) {
                    const changeRate = data.change_rate.toFixed(2);
                    const changePrice = Math.abs(data.change_price).toLocaleString();
                    const isPositive = data.change_rate >= 0;

                    changeElement.innerHTML = `
                        ë¹„íŠ¸ì½”ì¸ (BTC) 
                        <span class="${isPositive ? 'text-success' : 'text-danger'}">
                            ${isPositive ? '+' : ''}${changeRate}% (${isPositive ? '+' : '-'}â‚©${changePrice})
                        </span>
                    `;
                } else {
                    changeElement.textContent = 'ë¹„íŠ¸ì½”ì¸ (BTC)';
                }
            }
        } catch (error) {
            console.error('ë¹„íŠ¸ì½”ì¸ ê°€ê²© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            document.getElementById('btc-price').textContent = 'â‚© ì¡°íšŒ ì‹¤íŒ¨';
        }
    }

    // ì‹¤ì‹œê°„ ì°¨íŠ¸ ëª¨ë‹¬ í‘œì‹œ
    async function showRealtimeChart() {
        // ëª¨ë‹¬ì´ ì´ë¯¸ ì¡´ì¬í•˜ë©´ ì œê±°
        const existingModal = document.getElementById('chartModal');
        if (existingModal) existingModal.remove();

        // ëª¨ë‹¬ HTML ìƒì„±
        const modalHtml = `
            <div class="modal fade" id="chartModal" tabindex="-1">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-chart-line me-2"></i>
                                ë¹„íŠ¸ì½”ì¸ ì‹¤ì‹œê°„ ì°¨íŠ¸ (5ë¶„ë´‰)
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="chartContainer" style="height: 500px;">
                                <div class="d-flex justify-content-center align-items-center h-100">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">ì°¨íŠ¸ ë¡œë”©ì¤‘...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // ëª¨ë‹¬ì„ bodyì— ì¶”ê°€
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Bootstrap ëª¨ë‹¬ í‘œì‹œ
        const modal = new bootstrap.Modal(document.getElementById('chartModal'));
        modal.show();

        // ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
        await loadChart();
    }

    // ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ë° ë Œë”ë§
    async function loadChart() {
        try {
            const response = await fetch('/api/market/chart_data');
            const result = await response.json();

            if (result.success && result.data) {
                renderChart(result.data);
            } else {
                document.getElementById('chartContainer').innerHTML = `
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ì°¨íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                    </div>
                `;
            }
        } catch (error) {
            console.error('ì°¨íŠ¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            document.getElementById('chartContainer').innerHTML = `
                <div class="alert alert-danger text-center">
                    <i class="fas fa-times-circle me-2"></i>
                    ì°¨íŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                </div>
            `;
        }
    }

    // Chart.jsë¥¼ ì‚¬ìš©í•œ ì°¨íŠ¸ ë Œë”ë§
    function renderChart(data) {
        const ctx = document.createElement('canvas');
        ctx.style.height = '500px';
        document.getElementById('chartContainer').innerHTML = '';
        document.getElementById('chartContainer').appendChild(ctx);

        // ë°ì´í„° í¬ë§·íŒ…
        const labels = data.map(item => {
            const date = new Date(item.time);
            return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        });

        const prices = data.map(item => item.close);
        const volumes = data.map(item => item.volume);

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ë¹„íŠ¸ì½”ì¸ ê°€ê²©',
                    data: prices,
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    tension: 0.1,
                    pointRadius: 0,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    intersect: false,
                    mode: 'index'
                },
                scales: {
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'ì‹œê°„'
                        },
                        ticks: {
                            maxTicksLimit: 12
                        }
                    },
                    y: {
                        display: true,
                        title: {
                            display: true,
                            text: 'ê°€ê²© (KRW)'
                        },
                        ticks: {
                            callback: function (value) {
                                return 'â‚©' + value.toLocaleString();
                            }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return 'ê°€ê²©: â‚©' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê°€ê²© ì—…ë°ì´íŠ¸ ë° ì •ê¸°ì  ì—…ë°ì´íŠ¸ ì„¤ì •
    document.addEventListener('DOMContentLoaded', function () {
        // ì¦‰ì‹œ ê°€ê²© ì—…ë°ì´íŠ¸
        updateBitcoinPrice();

        // 30ì´ˆë§ˆë‹¤ ê°€ê²© ì—…ë°ì´íŠ¸
        setInterval(updateBitcoinPrice, 30000);
    });
</script>
{% endblock %}