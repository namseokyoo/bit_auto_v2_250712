name: Deploy to Oracle Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      env:
        HOST: ${{ secrets.ORACLE_HOST }}
        USER: ${{ secrets.ORACLE_USER }}
        KEY: ${{ secrets.ORACLE_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $HOST >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Deploy to Oracle Server
      env:
        HOST: ${{ secrets.ORACLE_HOST }}
        USER: ${{ secrets.ORACLE_USER }}
      run: |
        # 연결 테스트
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $USER@$HOST "echo 'SSH 연결 성공'"
        
        # 전체 프로젝트 동기화 (중요 파일들)
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r core/ $USER@$HOST:/opt/bitcoin_auto_trading/
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r web/ $USER@$HOST:/opt/bitcoin_auto_trading/
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r config/ $USER@$HOST:/opt/bitcoin_auto_trading/
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no main.py $USER@$HOST:/opt/bitcoin_auto_trading/
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no requirements.txt $USER@$HOST:/opt/bitcoin_auto_trading/
        
        # .env 파일은 서버에 이미 설정되어 있으므로 복사하지 않음
        
        # 서비스 재시작
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $USER@$HOST "sudo systemctl restart bitcoin-trading || echo 'restart failed but continuing...'"

    - name: Verify Deployment
      env:
        HOST: ${{ secrets.ORACLE_HOST }}
        USER: ${{ secrets.ORACLE_USER }}
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $USER@$HOST "ps aux | grep -E 'gunicorn|bitcoin-trading' | grep -v grep || echo 'No processes found'"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $USER@$HOST "curl -s -o /dev/null -w '%{http_code}' http://localhost:9000/health" || echo "Dashboard not accessible"
