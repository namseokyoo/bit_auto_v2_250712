name: Deploy to Oracle Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Deploy to Oracle Cloud
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.ORACLE_HOST }}
        username: ${{ secrets.ORACLE_USER }}
        key: ${{ secrets.ORACLE_SSH_KEY }}
        script: |
          echo "ğŸš€ ë°°í¬ ì‹œì‘: $(date)"
          
          # í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™
          cd /opt/btc-trading || { echo "âŒ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì—†ìŒ"; exit 1; }
          
          # Git pull (ê¶Œí•œ ë¬¸ì œ í•´ê²°)
          echo "ğŸ“¥ ì½”ë“œ ì—…ë°ì´íŠ¸ ì¤‘..."
          sudo git fetch origin main
          sudo git reset --hard origin/main
          
          # ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          if [ -f "requirements.txt" ]; then
            sudo /opt/btc-trading/venv/bin/pip install -r requirements.txt
          fi
          
          # ì„¤ì • íŒŒì¼ ë°±ì—…
          echo "ğŸ’¾ ì„¤ì • íŒŒì¼ ë°±ì—…..."
          sudo cp config/trading_config.json config/trading_config.backup.json
          
          # ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "â™»ï¸ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
          sudo systemctl restart btc-trading-engine
          sudo systemctl restart btc-trading-web
          
          # ìƒíƒœ í™•ì¸
          sleep 3
          echo "ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ:"
          sudo systemctl is-active btc-trading-engine && echo "âœ… íŠ¸ë ˆì´ë”© ì—”ì§„: ì •ìƒ" || echo "âŒ íŠ¸ë ˆì´ë”© ì—”ì§„: ì‹¤íŒ¨"
          sudo systemctl is-active btc-trading-web && echo "âœ… ì›¹ ì„œë²„: ì •ìƒ" || echo "âŒ ì›¹ ì„œë²„: ì‹¤íŒ¨"
          
          echo "ğŸ‰ ë°°í¬ ì™„ë£Œ: $(date)"