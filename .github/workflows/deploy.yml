name: Deploy to Oracle Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      env:
        HOST: ${{ secrets.ORACLE_HOST }}
        USER: ${{ secrets.ORACLE_USER }}
        KEY: ${{ secrets.ORACLE_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $HOST >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Deploy to Oracle Server
      env:
        HOST: ${{ secrets.ORACLE_HOST }}
        USER: ${{ secrets.ORACLE_USER }}
      run: |
        # 기존 방식으로 파일 복사
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no deploy.sh $USER@$HOST:/tmp/
        
        # 핵심 파일들 직접 복사
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r web/ $USER@$HOST:/opt/bitcoin_auto_trading/
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r core/ $USER@$HOST:/opt/bitcoin_auto_trading/
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r config/ $USER@$HOST:/opt/bitcoin_auto_trading/
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -r data/ $USER@$HOST:/opt/bitcoin_auto_trading/
        
        # 서비스 강제 재시작
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $USER@$HOST "
          sudo systemctl stop bitcoin-trading || true
          sleep 2
          sudo pkill -f gunicorn || true
          sleep 2
          sudo systemctl start bitcoin-trading
          sleep 5
          sudo systemctl status bitcoin-trading --no-pager || true
        "

    - name: Verify Deployment
      env:
        HOST: ${{ secrets.ORACLE_HOST }}
        USER: ${{ secrets.ORACLE_USER }}
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $USER@$HOST "ps aux | grep -E 'gunicorn|bitcoin-trading' | grep -v grep || echo 'No processes found'"
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $USER@$HOST "curl -s -o /dev/null -w '%{http_code}' http://localhost:9000/health" || echo "Dashboard not accessible"
