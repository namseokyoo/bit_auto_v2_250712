name: Deploy to Oracle Cloud

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      env:
        HOST: ${{ secrets.ORACLE_HOST }}
        USER: ${{ secrets.ORACLE_USER }}
        KEY: ${{ secrets.ORACLE_SSH_KEY }}
      run: |
        mkdir -p ~/.ssh
        echo "$KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $HOST >> ~/.ssh/known_hosts 2>/dev/null || true

    - name: Deploy to Oracle Server
      env:
        HOST: ${{ secrets.ORACLE_HOST }}
        USER: ${{ secrets.ORACLE_USER }}
      run: |
        # 연결 테스트
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $USER@$HOST "echo 'SSH 연결 성공'"
        
        # Git을 통한 최신 코드 가져오기
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $USER@$HOST "
          cd /home/ubuntu/bit_auto_v2 && 
          git fetch origin main && 
          git reset --hard origin/main &&
          echo '최신 코드 업데이트 완료'
        "
        
        # Python 패키지 업데이트 (필요시)
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $USER@$HOST "
          cd /home/ubuntu/bit_auto_v2 && 
          source venv/bin/activate && 
          pip install -r requirements.txt --quiet &&
          echo 'Python 패키지 업데이트 완료'
        "
        
        # 서비스 재시작
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 $USER@$HOST "
          sudo systemctl restart bitcoin-trading &&
          echo '서비스 재시작 완료'
        "

    - name: Verify Deployment
      env:
        HOST: ${{ secrets.ORACLE_HOST }}
        USER: ${{ secrets.ORACLE_USER }}
      run: |
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $USER@$HOST "ps aux | grep -E 'gunicorn|bitcoin-trading' | grep -v grep || echo 'No processes found'"

        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no $USER@$HOST "curl -s -o /dev/null -w '%{http_code}' http://localhost:9000/health || echo 'Dashboard not accessible'"